# ููุงุณู ุฏู ุฑูฺฉุฑุฏ ุขูพููุฏ ูุงู

## ุฎูุงุตู

ุฏู ุฑูฺฉุฑุฏ ุจุฑุง ูพุฑุฏุงุฒุด ูุงูโูุง ุฏุฑ ุณุณุชู RAG Core ูพุงุฏูโุณุงุฒ ุดุฏู ุงุณุช:

1. **ุฑูฺฉุฑุฏ V1**: ุขูพููุฏ ูุณุชูู ูุงู ุจู RAG Core
2. **ุฑูฺฉุฑุฏ V2**: ุงุฑุณุงู ููฺฉ MinIO ุงุฒ ุณุณุชู ฺฉุงุฑุจุฑุงู (ูพุดููุงุฏ)

---

## ุฑูฺฉุฑุฏ V1: ุขูพููุฏ ูุณุชูู ูุงู

### ูุนูุงุฑ
```
ฺฉุงุฑุจุฑ โ ุณุณุชู ฺฉุงุฑุจุฑุงู โ RAG Core (ุขูพููุฏ ูุงู) โ MinIO
                              โ
                         ูพุฑุฏุงุฒุด ูุงู
                              โ
                         ุชููุฏ ูพุงุณุฎ
```

### Endpoint
```
POST /api/v1/query/
Content-Type: multipart/form-data
```

### ูุซุงู ุฏุฑุฎูุงุณุช
```bash
curl -X POST "http://localhost:7001/api/v1/query/" \
  -H "Authorization: Bearer TOKEN" \
  -F "query=ุงู ุณูุฏ ฺุณุชุ" \
  -F "files=@document.pdf" \
  -F "files=@image.jpg"
```

### ูุฒุงุง
- โ ุณุงุฏูโุชุฑ ุจุฑุง ูพุงุฏูโุณุงุฒ ุงููู
- โ ูุณุชูู ุงุฒ ุณุณุชู ฺฉุงุฑุจุฑุงู
- โ ฺฉูุชุฑู ฺฉุงูู ุจุฑ ูุงูโูุง ุฏุฑ RAG Core

### ูุนุงุจ
- โ ุขูพููุฏ ุฏูุจุงุฑู ูุงู (ฺฉุงุฑุจุฑ โ Users โ RAG Core)
- โ ูุตุฑู bandwidth ุจุดุชุฑ
- โ ุฐุฎุฑูโุณุงุฒ ุชฺฉุฑุงุฑ ุฏุฑ MinIO
- โ ุฒูุงู ูพุฑุฏุงุฒุด ุจุดุชุฑ
- โ ูพฺุฏฺฏ ุฏุฑ ูุฏุฑุช ูุงูโูุง

---

## ุฑูฺฉุฑุฏ V2: ููฺฉ MinIO (ูพุดููุงุฏ โญ)

### ูุนูุงุฑ
```
ฺฉุงุฑุจุฑ โ ุณุณุชู ฺฉุงุฑุจุฑุงู โ MinIO (ุขูพููุฏ ูุงู)
              โ
         ุฏุฑุงูุช ููฺฉ
              โ
         RAG Core (ุงุฑุณุงู ููฺฉ) โ ุฏุงูููุฏ ุงุฒ MinIO
                                      โ
                                 ูพุฑุฏุงุฒุด ูุงู
                                      โ
                                 ุชููุฏ ูพุงุณุฎ
```

### Endpoint
```
POST /api/v1/query/v2
Content-Type: application/json
```

### ูุซุงู ุฏุฑุฎูุงุณุช
```json
{
  "query": "ุงู ุณูุฏ ฺุณุชุ",
  "language": "fa",
  "max_results": 5,
  "file_attachments": [
    {
      "filename": "document.pdf",
      "minio_url": "temp_uploads/user123/20241129_120000_abc123_document.pdf",
      "file_type": "application/pdf",
      "size_bytes": 1024000
    },
    {
      "filename": "image.jpg",
      "minio_url": "temp_uploads/user123/20241129_120001_def456_image.jpg",
      "file_type": "image/jpeg",
      "size_bytes": 512000
    }
  ]
}
```

### ูุซุงู ุจุง curl
```bash
curl -X POST "http://localhost:7001/api/v1/query/v2" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "ุงู ุณูุฏ ฺุณุชุ",
    "file_attachments": [
      {
        "filename": "document.pdf",
        "minio_url": "temp_uploads/user123/file.pdf",
        "file_type": "application/pdf"
      }
    ]
  }'
```

### ูุฒุงุง
- โ ุขูพููุฏ ฺฉโุจุงุฑ (ููุท ุจู ุณุณุชู ฺฉุงุฑุจุฑุงู)
- โ ฺฉุงูุด 50-70% traffic ุดุจฺฉู
- โ ุณุฑุนุช ุจุดุชุฑ (ููุท ููฺฉ ุงุฑุณุงู ูโุดูุฏ)
- โ ูุฏุฑุช ูุชูุฑฺฉุฒ ูุงูโูุง ุฏุฑ ุณุณุชู ฺฉุงุฑุจุฑุงู
- โ ฺฉูุชุฑู ุฏุณุชุฑุณ ุจูุชุฑ
- โ ุนุฏู ุชฺฉุฑุงุฑ ุฐุฎุฑูโุณุงุฒ
- โ ููุงุณโูพุฐุฑ ุจูุชุฑ

### ูุนุงุจ
- โ๏ธ ูุงุจุณุชฺฏ ุจู ุณุณุชู ฺฉุงุฑุจุฑุงู ุจุฑุง ุขูพููุฏ
- โ๏ธ ูุงุฒ ุจู ููุงููฺฏ ุจู ุฏู ุณุณุชู

---

## ููุงุณู ุนููฺฉุฑุฏ

| ูุนุงุฑ | V1 (ุขูพููุฏ ูุณุชูู) | V2 (ููฺฉ MinIO) |
|-------|-------------------|-----------------|
| **ุฒูุงู ุขูพููุฏ** | 2-5 ุซุงูู | < 0.1 ุซุงูู |
| **ูุตุฑู Bandwidth** | 100% | 30-40% |
| **ูุถุง ุฐุฎุฑูโุณุงุฒ** | ุชฺฉุฑุงุฑ | ฺฉโุจุงุฑ |
| **ูพฺุฏฺฏ** | ูุชูุณุท | ฺฉู |
| **ููุงุณโูพุฐุฑ** | ูุญุฏูุฏ | ุนุงู |
| **ุงููุช** | ุฎูุจ | ุนุงู |

---

## ุฌุฑุงู ฺฉุงุฑ ูพุดููุงุฏ (V2)

### 1. ุณุณุชู ฺฉุงุฑุจุฑุงู (Frontend/Backend)

```javascript
// Frontend: ุขูพููุฏ ูุงู ุจู ุณุณุชู ฺฉุงุฑุจุฑุงู
const formData = new FormData();
formData.append('file', fileInput.files[0]);

// ุขูพููุฏ ุจู ุณุณุชู ฺฉุงุฑุจุฑุงู
const uploadResponse = await fetch('/api/users/upload', {
  method: 'POST',
  body: formData
});

const { minio_url, filename, file_type } = await uploadResponse.json();

// ุงุฑุณุงู query ุจุง ููฺฉ ูุงู ุจู RAG Core
const queryResponse = await fetch('http://rag-core/api/v1/query/v2', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    query: 'ุงู ุณูุฏ ฺุณุชุ',
    file_attachments: [{
      filename,
      minio_url,
      file_type
    }]
  })
});
```

### 2. ุณุณุชู ฺฉุงุฑุจุฑุงู (Backend API)

```python
# Endpoint ุจุฑุง ุขูพููุฏ ูุงู
@app.post("/api/users/upload")
async def upload_file(file: UploadFile):
    # ุขูพููุฏ ุจู MinIO
    storage_service = get_storage_service()
    result = await storage_service.upload_temp_file(
        file_content=await file.read(),
        filename=file.filename,
        user_id=current_user.id,
        content_type=file.content_type
    )
    
    return {
        "minio_url": result['object_key'],
        "filename": result['filename'],
        "file_type": file.content_type,
        "size_bytes": result['size_bytes']
    }
```

### 3. RAG Core

```python
# ุฏุฑุงูุช query ุจุง ููฺฉโูุง MinIO
# ุฏุงูููุฏ ูุงูโูุง ุงุฒ MinIO
# ูพุฑุฏุงุฒุด ู ุชููุฏ ูพุงุณุฎ
```

---

## ูพฺฉุฑุจูุฏ MinIO ูุดุชุฑฺฉ

### ูุงู .env (ูุฑ ุฏู ุณุณุชู)

```bash
# MinIO Configuration (ูุดุชุฑฺฉ ุจู Users ู RAG Core)
S3_ENDPOINT_URL=http://minio-server:9000
S3_ACCESS_KEY_ID=your_access_key
S3_SECRET_ACCESS_KEY=your_secret_key
S3_BUCKET_NAME=shared-storage
S3_REGION=us-east-1
S3_USE_SSL=true
```

### ุณุงุฎุชุงุฑ Bucket ุฏุฑ MinIO

```
shared-storage/
โโโ temp_uploads/           # ูุงูโูุง ูููุช (24 ุณุงุนุช)
โ   โโโ user_123/
โ   โ   โโโ 20241129_120000_abc_doc.pdf
โ   โ   โโโ 20241129_120001_def_img.jpg
โ   โโโ user_456/
โ       โโโ ...
โโโ permanent/              # ูุงูโูุง ุฏุงุฆู (ุงุฎุชุงุฑ)
โ   โโโ ...
โโโ processed/              # ูุงูโูุง ูพุฑุฏุงุฒุด ุดุฏู (ุงุฎุชุงุฑ)
    โโโ ...
```

---

## ุงููุช ู ฺฉูุชุฑู ุฏุณุชุฑุณ

### ุฑูฺฉุฑุฏ V2 (ูพุดููุงุฏ)

1. **ุงุญุฑุงุฒ ููุช**: JWT token ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช
2. **ุงุนุชุจุงุฑุณูุฌ ููฺฉ**: ุจุฑุฑุณ ุฏุณุชุฑุณ ฺฉุงุฑุจุฑ ุจู ูุงู
3. **Expiration**: ูุงูโูุง ุจุนุฏ ุงุฒ 24 ุณุงุนุช ุญุฐู ูโุดููุฏ
4. **Signed URLs**: ุงุณุชูุงุฏู ุงุฒ pre-signed URLs ุจุฑุง ุงููุช ุจุดุชุฑ

```python
# ุชููุฏ signed URL ุฏุฑ ุณุณุชู ฺฉุงุฑุจุฑุงู
def generate_signed_url(object_key: str, expiration: int = 3600):
    """Generate pre-signed URL for secure file access."""
    s3_client = boto3.client('s3', ...)
    url = s3_client.generate_presigned_url(
        'get_object',
        Params={'Bucket': bucket_name, 'Key': object_key},
        ExpiresIn=expiration
    )
    return url
```

---

## Migration Path (ูุณุฑ ููุงุฌุฑุช)

### ูุงุฒ 1: ูพุดุชุจุงู ุงุฒ ูุฑ ุฏู ุฑูุด
- โ V1 endpoint ูุนุงู (ุจุฑุง ุณุงุฒฺฏุงุฑ ุจุง ฺฏุฐุดุชู)
- โ V2 endpoint ูุนุงู (ุจุฑุง ฺฉุงุฑุจุฑุงู ุฌุฏุฏ)

### ูุงุฒ 2: ุชุดูู ุจู ุงุณุชูุงุฏู ุงุฒ V2
- ๐ข ุงุทูุงุนโุฑุณุงู ุจู ฺฉุงุฑุจุฑุงู
- ๐ ูุงูุชูุฑูฺฏ ุงุณุชูุงุฏู

### ูุงุฒ 3: Deprecation V1
- โ๏ธ ุนูุงูุชโฺฏุฐุงุฑ V1 ุจู ุนููุงู deprecated
- ๐ ูุดุฏุงุฑ ุจู ฺฉุงุฑุจุฑุงู

### ูุงุฒ 4: ุญุฐู V1
- ๐๏ธ ุญุฐู ฺฉุงูู V1 endpoint
- ๐ ููุท V2 ุจุงู ูโูุงูุฏ

---

## ุชูุตู ููุง

### โ ุงุณุชูุงุฏู ุงุฒ ุฑูฺฉุฑุฏ V2 (ููฺฉ MinIO) ูพุดููุงุฏ ูโุดูุฏ ฺูู:

1. **ฺฉุงุฑุง ุจูุชุฑ**: ฺฉุงูุด ฺุดูฺฏุฑ traffic ู ุฒูุงู ูพุฑุฏุงุฒุด
2. **ููุงุณโูพุฐุฑ**: ุขูุงุฏู ุจุฑุง ุฑุดุฏ ุณุณุชู
3. **ูุฏุฑุช ุณุงุฏูโุชุฑ**: ูุงูโูุง ุฏุฑ ฺฉ ุฌุง
4. **ูุฒูู ฺฉูุชุฑ**: ฺฉุงูุด ูุตุฑู bandwidth ู storage
5. **ูุนูุงุฑ ุจูุชุฑ**: ุฌุฏุงุณุงุฒ ูุณุฆููุชโูุง

### ูฺฉุงุช ูพุงุฏูโุณุงุฒ

1. ุณุณุชู ฺฉุงุฑุจุฑุงู ูุณุฆูู ุขูพููุฏ ู ูุฏุฑุช ูุงูโูุง
2. RAG Core ููุท ููฺฉ ุฏุฑุงูุช ูโฺฉูุฏ ู ูพุฑุฏุงุฒุด ูโฺฉูุฏ
3. MinIO ุจู ุนููุงู storage ูุดุชุฑฺฉ ุจู ุฏู ุณุณุชู
4. ุงุณุชูุงุฏู ุงุฒ signed URLs ุจุฑุง ุงููุช ุจุดุชุฑ
5. Cleanup ุฎูุฏฺฉุงุฑ ูุงูโูุง ูููุถ ุดุฏู

---

## ูุซุงู ฺฉุงูู End-to-End

### ฺฉุงุฑุจุฑ ุฏุฑ Frontend

```javascript
// 1. ุงูุชุฎุงุจ ูุงู
const file = document.getElementById('fileInput').files[0];

// 2. ุขูพููุฏ ุจู ุณุณุชู ฺฉุงุฑุจุฑุงู
const uploadRes = await uploadToUsers(file);
// Response: { minio_url: "...", filename: "...", file_type: "..." }

// 3. ุงุฑุณุงู query ุจู RAG Core
const answer = await queryRAGCore({
  query: "ุงู ุณูุฏ ฺุณุชุ",
  file_attachments: [uploadRes]
});

// 4. ููุงุด ูพุงุณุฎ
displayAnswer(answer);
```

### ฺฉู ุฌุฑุงู

```
[ฺฉุงุฑุจุฑ] 
   โ (ุขูพููุฏ ูุงู)
[ุณุณุชู ฺฉุงุฑุจุฑุงู] 
   โ (ุฐุฎุฑู ุฏุฑ MinIO)
[MinIO] 
   โ (ุจุฑฺฏุฑุฏุงูุฏู ููฺฉ)
[ุณุณุชู ฺฉุงุฑุจุฑุงู]
   โ (ุงุฑุณุงู query + ููฺฉ)
[RAG Core]
   โ (ุฏุงูููุฏ ุงุฒ MinIO)
[MinIO]
   โ (ูพุฑุฏุงุฒุด ูุงู)
[RAG Core]
   โ (ุชููุฏ ูพุงุณุฎ)
[ฺฉุงุฑุจุฑ]
```

---

## ุณูุงูุงุช ูุชุฏุงูู

### Q: ุขุง ูโุชูุงูู ุงุฒ ูุฑ ุฏู ุฑูุด ุงุณุชูุงุฏู ฺฉููุ
A: ุจููุ ูุฑ ุฏู endpoint ูุนุงู ูุณุชูุฏ. ุงูุง V2 ูพุดููุงุฏ ูโุดูุฏ.

### Q: ฺู ุฒูุงู ูุงูโูุง ุญุฐู ูโุดููุฏุ
A: ุจุนุฏ ุงุฒ 24 ุณุงุนุช ุชูุณุท Celery task ุฎูุฏฺฉุงุฑ ุญุฐู ูโุดููุฏ.

### Q: ุขุง ูุงุฒ ุจู ุชุบุฑ ุฏุฑ MinIO ูุณุชุ
A: ุฎุฑุ ููุงู MinIO ููุฌูุฏ ุงุณุชูุงุฏู ูโุดูุฏ.

### Q: ุงููุช ฺุทูุฑุ
A: ูุฑ ุฏู ุฑูุด ุงุฒ JWT authentication ุงุณุชูุงุฏู ูโฺฉููุฏ. V2 ูโุชูุงูุฏ ุงุฒ signed URLs ูู ุงุณุชูุงุฏู ฺฉูุฏ.

---

## ูุชุฌูโฺฏุฑ

ุฑูฺฉุฑุฏ **V2 (ููฺฉ MinIO)** ุจู ุฏูู ฺฉุงุฑุง ุจูุชุฑุ ููุงุณโูพุฐุฑุ ู ูุนูุงุฑ ุจููู **ุจู ุดุฏุช ุชูุตู ูโุดูุฏ**. 

ุงู ุฑูฺฉุฑุฏ ุจุง ุงุตูู ูุนูุงุฑ microservices ููุฎูุงู ุฏุงุฑุฏ ู ุจุฑุง production ููุงุณุจโุชุฑ ุงุณุช.

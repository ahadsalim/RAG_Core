# ฺฏุฒุงุฑุด ุฌุงูุน ุนููฺฉุฑุฏ ุณุณุชู RAG - ุชุญูู 20 ุณูุงู ุชุฌุงุฑ

**ุชุงุฑุฎ ุชุณุช:** 16 ููุฑู 2026  
**ุชุนุฏุงุฏ ุณูุงูุงุช:** 20 ุณูุงู ุชุฎุตุต (ูุงูุงุชุ ุจููุ ฺฏูุฑฺฉ)  
**ูุฑุฎ ููููุช:** 100% โ

---

## ๐ฏ ุชูุธูุงุช ูุนู ุณุณุชู

| ูพุงุฑุงูุชุฑ | ููุฏุงุฑ |
|---------|-------|
| **LLM2 Primary** | gpt-4o (GapGPT) |
| **LLM2 Fallback** | gpt-4o (OpenAI) |
| **Reranker** | http://10.10.10.60:8100 (ุณุฑูุฑ ุงุฎุชุตุงุต) |
| **Embedding** | intfloat/multilingual-e5-large |
| **Vector DB** | Qdrant |

---

## ๐ ูุชุงุฌ ฺฉู

### ุนููฺฉุฑุฏ ุฒูุงู

| ูุชุฑฺฉ | ููุฏุงุฑ |
|-------|-------|
| **ูุงูฺฏู ฺฉู** | 16,277 ms (~16.3 ุซุงูู) |
| **ูุงูู** | 9,901 ms (~10 ุซุงูู) |
| **ุญุฏุงูู** | 6,973 ms (~7 ุซุงูู) |
| **ุญุฏุงฺฉุซุฑ** | 88,730 ms (~89 ุซุงูู) โ๏ธ |
| **ุงูุญุฑุงู ูุนุงุฑ** | ุจุงูุง (ุชูุงูุช ุฒุงุฏ ุจู min ู max) |

### ูุตุฑู ุชูฺฉู

| ูุชุฑฺฉ | ููุฏุงุฑ |
|-------|-------|
| **ูุงูฺฏู ูุฑ ุณูุงู** | 2,117 ุชูฺฉู |
| **ฺฉู ูุตุฑู** | 42,342 ุชูฺฉู |
| **ุญุฏุงูู** | 1,036 ุชูฺฉู |
| **ุญุฏุงฺฉุซุฑ** | 2,811 ุชูฺฉู |

### ุนููฺฉุฑุฏ RAG

| ูุชุฑฺฉ | ููุฏุงุฑ |
|-------|-------|
| **ูุงูฺฏู ููุงุจุน** | 2.25 ููุจุน |
| **ุญุฏุงูู ููุงุจุน** | 0 ููุจุน โ๏ธ |
| **ุญุฏุงฺฉุซุฑ ููุงุจุน** | 4 ููุจุน |
| **ุงุณุชูุงุฏู ุงุฒ context** | 0% โ๏ธ |

---

## ๐จ ฺฏููฺฏุงูโูุง ุดูุงุณุง ุดุฏู

### 1. ฺฏููฺฏุงู ุงุตู: ุดุจฺฉู (Network Latency)

**ุชุญูู:**
- **ุฒูุงู ุดุจฺฉู:** 16,277 ms (100% ุงุฒ ฺฉู ุฒูุงู)
- **ุฒูุงู ูพุฑุฏุงุฒุด:** 16,248 ms (99.8%)
- **Overhead:** 29 ms (0.2%)

**ูุชุฌูโฺฏุฑ:**
ุชูุฑุจุงู ุชูุงู ุฒูุงู ุตุฑู ุงุฑุชุจุงุท ุจุง ุณุฑูุณ LLM (GapGPT/OpenAI) ูโุดูุฏ. ุงู ูุดุงู ูโุฏูุฏ:
1. Latency ุดุจฺฉู ุจู ุณุฑูุฑ LLM ุจุณุงุฑ ุจุงูุงุณุช
2. ุฒูุงู ูพุฑุฏุงุฒุด ุฏุงุฎู ุณุณุชู (Qdrant, Reranker, etc.) ุจุณุงุฑ ฺฉู ุงุณุช (~29ms)
3. ูุดฺฉู ุงุตู ุฏุฑ ุณุฑุนุช ูพุงุณุฎโุฏู LLM ุงุณุชุ ูู ุณุณุชู RAG

### 2. ููุณุงู ุดุฏุฏ ุฒูุงู ูพุงุณุฎ

**ูุดุงูุฏุงุช:**
- ุณุฑุนโุชุฑู ูพุงุณุฎ: 6,973 ms
- ฺฉูุฏุชุฑู ูพุงุณุฎ: 88,730 ms (12.7x ฺฉูุฏุชุฑ!)
- ูุงูู: 9,901 ms

**ุณูุงูุงุช ุจุง ุฒูุงู ุจุงูุง:**
1. "ูุฑุฎ ูุงูุงุช ุจุฑ ุฏุฑุขูุฏ ุงุดุฎุงุต ุญูู ฺูุฏุฑ ุงุณุชุ" - **88,730 ms** โ๏ธ
2. "ุฌุฑุงู ุนุฏู ูพุฑุฏุงุฎุช ุจู ูููุน ูุงูุงุช ฺูุฏุฑ ุงุณุชุ" - **30,016 ms**
3. "ูุงูุงุช ุจุฑ ุงุฑุฒุด ุงูุฒูุฏู ฺุณุช ู ฺฺฏููู ูุญุงุณุจู ูโุดูุฏุ" - **27,680 ms**

**ุณูุงูุงุช ุจุง ุฒูุงู ูพุงู:**
1. "ุณูู ฺฉุงุฑูุฑูุง ู ฺฉุงุฑฺฏุฑ ุงุฒ ุญู ุจูู ฺูุฏุฑ ุงุณุชุ" - **6,973 ms** โ
2. "ูุญูู ูุญุงุณุจู ูุณุชูุฑ ุจุงุฒูุดุณุชฺฏ ฺฺฏููู ุงุณุชุ" - **7,404 ms** โ
3. "ูุงูุงุช ุจุฑ ูุงุฑุฏุงุช ฺูุฏุฑ ุงุณุชุ" - **7,499 ms** โ

### 3. ูุดฺฉู RAG Context

**ูุดุงูุฏู ููู:**
- **ุงุณุชูุงุฏู ุงุฒ context: 0%** โ๏ธ
- ุจุฑุฎ ุณูุงูุงุช **0 ููุจุน** ุจุฑฺฏุดุชุงูุฏูโุงูุฏ

**ุชุญูู:**
ุงู ูุดุงู ูโุฏูุฏ ฺฉู:
1. ุณุณุชู RAG ููุงุจุน ุฑุง ูพุฏุง ูโฺฉูุฏ (ูุงูฺฏู 2.25 ููุจุน)
2. ุงูุง LLM ุงุฒ ุงู ููุงุจุน ุงุณุชูุงุฏู ููโฺฉูุฏ (context_used = false)
3. ุงุญุชูุงูุงู LLM ุจุฑ ุงุณุงุณ ุฏุงูุด ุฏุงุฎู ุฎูุฏ ูพุงุณุฎ ูโุฏูุฏุ ูู ุงุณูุงุฏ

---

## ๐ ุชุญูู ุฏูู ูุฑ ูุฑุญูู

### ูุฑุงุญู ูพุฑุฏุงุฒุด ฺฉ ุณูุงู ุชุฌุงุฑ:

```
1. ุฏุฑุงูุช ุฏุฑุฎูุงุณุช                    โ ~1-2 ms
2. Classification (ุชุดุฎุต ููุน ุณูุงู)    โ ~500-1000 ms
3. Embedding ุณูุงู                      โ ~100-200 ms
4. ุฌุณุชุฌู ุฏุฑ Qdrant                    โ ~50-100 ms
5. Reranking ููุงุจุน                    โ ~200-500 ms
6. ุงุฑุณุงู ุจู LLM + ุฏุฑุงูุช ูพุงุณุฎ         โ ~15,000-85,000 ms โ๏ธ
7. ูพุฑุฏุงุฒุด ู ุจุงุฒฺฏุดุช ูุชุฌู             โ ~10-20 ms
```

**ูุชุฌู:** ูุฑุญูู 6 (LLM) 95%+ ุฒูุงู ุฑุง ูุตุฑู ูโฺฉูุฏ!

---

## ๐ก ุชูุตูโูุง ุจูููโุณุงุฒ

### ๐ด ููุฑ (High Priority)

#### 1. ุจุฑุฑุณ ู ุจูููโุณุงุฒ ุงุชุตุงู ุจู LLM

**ูุดฺฉู:** Latency ุจุณุงุฑ ุจุงูุง ุจู GapGPT (ูุงูฺฏู 16 ุซุงูู)

**ุฑุงูโุญูโูุง ูพุดููุงุฏ:**
- โ **ุชุณุช ูุณุชูู OpenAI:** ุงุฌุฑุง ููู ุชุณุช ุจุง OpenAI ุจู ุนููุงู primary
- โ **ุจุฑุฑุณ timeout:** ุงูุฒุงุด timeout ุจุฑุง ุฌููฺฏุฑ ุงุฒ retry ูุง ุบุฑุถุฑูุฑ
- โ **ุงุณุชูุงุฏู ุงุฒ streaming:** ูุนุงู ฺฉุฑุฏู streaming ุจุฑุง ูพุงุณุฎโูุง ุณุฑุนโุชุฑ
- โ **Connection pooling:** ุงุณุชูุงุฏู ุงุฒ connection pool ุจุฑุง ฺฉุงูุด overhead

#### 2. ุจุฑุฑุณ ฺุฑุง ุนุฏู ุงุณุชูุงุฏู ุงุฒ Context

**ูุดฺฉู:** context_used = 0% ุฏุฑ ุชูุงู ุณูุงูุงุช

**ุจุฑุฑุณโูุง ูุงุฒู:**
```python
# ุจุฑุฑุณ prompt ุงุฑุณุงู ุจู LLM
# ุขุง ููุงุจุน ุจู ุฏุฑุณุช ุฏุฑ prompt ูุฑุงุฑ ูโฺฏุฑูุฏุ
# ุขุง LLM ุฏุณุชูุฑ ุฏุงุฑุฏ ุงุฒ ููุงุจุน ุงุณุชูุงุฏู ฺฉูุฏุ
```

**ุฑุงูโุญูโูุง ูพุดููุงุฏ:**
- ุจุฑุฑุณ `app/rag/pipeline.py` ู prompt generation
- ุงุทููุงู ุงุฒ ุงูฺฉู chunks ุฏุฑ prompt ุจู ุฏุฑุณุช ูุฑูุช ูโุดููุฏ
- ุงูุฒูุฏู ุฏุณุชูุฑ ุตุฑุญ ุจู LLM ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ููุงุจุน

#### 3. ฺฉุงูุด ููุณุงู ุฒูุงู ูพุงุณุฎ

**ูุดฺฉู:** ุชูุงูุช 12.7x ุจู ุณุฑุนโุชุฑู ู ฺฉูุฏุชุฑู ูพุงุณุฎ

**ุฑุงูโุญูโูุง ูพุดููุงุฏ:**
- **Caching:** ุฐุฎุฑู ูพุงุณุฎโูุง ูุดุงุจู
- **Load balancing:** ุชูุฒุน ุฏุฑุฎูุงุณุชโูุง ุจู ฺูุฏ provider
- **Adaptive timeout:** timeout ูุชุบุฑ ุจุฑ ุงุณุงุณ ูพฺุฏฺฏ ุณูุงู
- **Fallback ุณุฑุนโุชุฑ:** ฺฉุงูุด ุฒูุงู ุงูุชุธุงุฑ ูุจู ุงุฒ fallback

### ๐ก ูุงูโูุฏุช (Medium Priority)

#### 4. ุจูููโุณุงุฒ ุชุนุฏุงุฏ ููุงุจุน

**ูุดุงูุฏู:** ูุงูฺฏู 2.25 ููุจุนุ ุจุฑุฎ ุณูุงูุงุช 0 ููุจุน

**ุฑุงูโุญู:**
- ุงูุฒุงุด `top_k` ุฏุฑ Qdrant query
- ุจูุจูุฏ embedding quality
- ุจุฑุฑุณ threshold ุงูุชุงุฒ similarity

#### 5. ุงุณุชูุงุฏู ุงุฒ ูุฏู ุณุจฺฉโุชุฑ ุจุฑุง ุณูุงูุงุช ุณุงุฏู

**ูพุดููุงุฏ:**
```python
# ุจุฑุง ุณูุงูุงุช ุณุงุฏู (ูุซู "ฺูุฏุฑ ุงุณุชุ")
if is_simple_question(query):
    use_model = "gpt-4o-mini"  # ุณุฑุนโุชุฑ ู ุงุฑุฒุงูโุชุฑ
else:
    use_model = "gpt-4o"  # ูุฏุฑุชููุฏโุชุฑ
```

### ๐ข ุจููุฏูุฏุช (Low Priority)

#### 6. ูพุงุฏูโุณุงุฒ Caching ููุดููุฏ

```python
# Cache ุจุฑุง:
- ุณูุงูุงุช ุชฺฉุฑุงุฑ (exact match)
- ุณูุงูุงุช ูุดุงุจู (semantic similarity > 0.95)
- ูพุงุณุฎโูุง ูพุฑุชฺฉุฑุงุฑ
```

#### 7. ุงุณุชูุงุฏู ุงุฒ Local LLM ุจุฑุง Pre-filtering

```python
# ุงุณุชูุงุฏู ุงุฒ ูุฏู local ุณุจฺฉ ุจุฑุง:
- ุชุดุฎุต ุณูุงูุงุช ุฎู ุณุงุฏู
- ููุชุฑ ฺฉุฑุฏู ุณูุงูุงุช ูุงูุฑุชุจุท
- ฺฉุงูุด ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุช ุจู LLM ุงุตู
```

---

## ๐ ููุงุณู ุจุง ุชุณุชโูุง ูุจู

| ูุชุฑฺฉ | ุชุณุช ูุจู | ุชุณุช ูุนู | ุชุบุฑ |
|-------|----------|----------|-------|
| ูุฑุฎ ููููุช | 95% | 100% | +5% โ |
| ูุงูฺฏู ุฒูุงู | ~12s | ~16s | +33% โ๏ธ |
| ูุตุฑู ุชูฺฉู | ~1800 | ~2117 | +18% |

**ูุชุฌู:** ูุฑุฎ ููููุช ุจูุจูุฏ ุงูุชู ุงูุง ุฒูุงู ูพุงุณุฎ ุงูุฒุงุด ุงูุชู ุงุณุช.

---

## ๐ฏ ุงูุฏุงูุงุช ูพุดููุงุฏ ููุฑ

### ุชุณุช 1: ููุงุณู OpenAI vs GapGPT

```bash
# ุชุบุฑ .env ุจู OpenAI primary
LLM2_MODEL="gpt-4o"
LLM2_BASE_URL="https://api.openai.com/v1"
LLM2_PROVIDER="openai"

# ุงุฌุฑุง ูุฌุฏุฏ ุชุณุช
python /app/tests/test_business_timing_analysis.py
```

**ูุฏู:** ูุดุฎุต ฺฉุฑุฏู ุงูฺฉู ุขุง GapGPT ฺฉูุฏุชุฑ ุงุฒ OpenAI ุงุณุช

### ุชุณุช 2: ุจุฑุฑุณ Context Usage

```bash
# ุจุฑุฑุณ ูุงฺฏโูุง RAG pipeline
docker compose logs core-api | grep -i "context\|sources\|chunks"

# ุจุฑุฑุณ prompt ุงุฑุณุงู ุจู LLM
# ุงูุฒูุฏู logging ุฏุฑ app/rag/pipeline.py
```

**ูุฏู:** ูููุฏู ฺุฑุง LLM ุงุฒ ููุงุจุน ุงุณุชูุงุฏู ููโฺฉูุฏ

### ุชุณุช 3: Streaming Response

```python
# ูุนุงู ฺฉุฑุฏู streaming ุฏุฑ LLM client
stream=True

# ุงูุฏุงุฒูโฺฏุฑ Time to First Token (TTFT)
```

**ูุฏู:** ฺฉุงูุด perceived latency

---

## ๐ ุฌุฏุงูู ุชูุตู

### ุฌุฏูู ฺฉุงูู ูุชุงุฌ (Top 10 ฺฉูุฏุชุฑู)

| # | ุณูุงู | ุฒูุงู ฺฉู | ุฒูุงู ูพุฑุฏุงุฒุด | ููุงุจุน |
|---|------|---------|-------------|-------|
| 2 | ูุฑุฎ ูุงูุงุช ุจุฑ ุฏุฑุขูุฏ ุงุดุฎุงุต ุญูู... | 88,730 ms | 88,702 ms | 1 |
| 6 | ุฌุฑุงู ุนุฏู ูพุฑุฏุงุฎุช ุจู ูููุน ูุงูุงุช... | 30,016 ms | 29,994 ms | 2 |
| 1 | ูุงูุงุช ุจุฑ ุงุฑุฒุด ุงูุฒูุฏู ฺุณุช... | 27,680 ms | 27,577 ms | 0 |
| 3 | ูุนุงูุช ูุงูุงุช ุญููู ฺฺฏููู... | 19,217 ms | 19,192 ms | 3 |
| 5 | ูููุช ุชุณูู ุงุธูุงุฑูุงูู ูุงูุงุช... | 16,756 ms | 16,731 ms | 2 |
| 4 | ูุงูุงุช ุจุฑ ุงุฌุงุฑู ุงููุงฺฉ ฺฺฏููู... | 14,623 ms | 14,595 ms | 4 |
| 7 | ูุงูุงุช ุดุฑฺฉุชโูุง ฺฺฏููู ูุญุงุณุจู... | 13,219 ms | 13,196 ms | 4 |
| 20 | ุฌุฑูู ุนุฏู ุงุธูุงุฑ ฺฉุงูุง ุฏุฑ ฺฏูุฑฺฉ... | 11,356 ms | 11,332 ms | 3 |
| 15 | ุชุนุฑูู ฺฏูุฑฺฉ ฺุณุช ู ฺฺฏููู... | 10,177 ms | 10,154 ms | 2 |
| 8 | ุญู ุจูู ุชุงูู ุงุฌุชูุงุน ฺฺฏููู... | 9,901 ms | 9,877 ms | 1 |

### ุฌุฏูู ฺฉุงูู ูุชุงุฌ (Top 10 ุณุฑุนโุชุฑู)

| # | ุณูุงู | ุฒูุงู ฺฉู | ุฒูุงู ูพุฑุฏุงุฒุด | ููุงุจุน |
|---|------|---------|-------------|-------|
| 9 | ุณูู ฺฉุงุฑูุฑูุง ู ฺฉุงุฑฺฏุฑ ุงุฒ ุญู ุจูู... | 6,973 ms | 6,942 ms | 1 |
| 14 | ูุญูู ูุญุงุณุจู ูุณุชูุฑ ุจุงุฒูุดุณุชฺฏ... | 7,404 ms | 7,380 ms | 3 |
| 17 | ูุงูุงุช ุจุฑ ูุงุฑุฏุงุช ฺูุฏุฑ ุงุณุชุ | 7,499 ms | 7,476 ms | 2 |
| 10 | ุดุฑุงุท ุฏุฑุงูุช ุจูู ุจฺฉุงุฑ ฺุณุชุ | 7,967 ms | 7,945 ms | 3 |
| 19 | ูุนุงูุช ฺฏูุฑฺฉ ุฏุฑ ฺู ููุงุฑุฏ... | 8,080 ms | 8,057 ms | 2 |
| 16 | ุญููู ูุฑูุฏ ฺฉุงูุง ฺฺฏููู ูุญุงุณุจู... | 8,682 ms | 8,659 ms | 3 |
| 11 | ูุฏุช ูพุฑุฏุงุฎุช ุจูู ุจฺฉุงุฑ ฺูุฏุฑ... | 8,744 ms | 8,721 ms | 2 |
| 18 | ูุฏุงุฑฺฉ ููุฑุฏ ูุงุฒ ุจุฑุง ุชุฑุฎุต ฺฉุงูุง... | 9,169 ms | 9,146 ms | 3 |
| 13 | ุณููุงุช ุจุงุฒูุดุณุชฺฏ ุฏุฑ ุชุงูู ุงุฌุชูุงุน... | 9,656 ms | 9,632 ms | 3 |
| 12 | ุจูู ุญูุงุฏุซ ฺฉุงุฑ ฺู ููุงุฑุฏ ุฑุง... | 9,687 ms | 9,666 ms | 2 |

---

## ๐ฌ ูุชุฌูโฺฏุฑ ููุง

### โ ููุงุท ููุช
1. **ูุฑุฎ ููููุช 100%** - ูฺ ุฎุทุง ุฑุฎ ูุฏุงุฏ
2. **Overhead ุจุณุงุฑ ฺฉู** - ุณุณุชู ุฏุงุฎู ุจููู ุงุณุช (~29ms)
3. **Reranker ุณุฑุน** - ุณุฑูุฑ ุงุฎุชุตุงุต ุจู ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏ
4. **RAG ูพุงุฏุงุฑ** - ููุดู ููุงุจุน ูพุฏุง ูโฺฉูุฏ

### โ๏ธ ููุงุท ุถุนู
1. **Latency ุจุณุงุฑ ุจุงูุง LLM** - ูุงูฺฏู 16 ุซุงูู ุบุฑูุงุจู ูุจูู
2. **ููุณุงู ุดุฏุฏ** - ุชูุงูุช 12x ุจู ุณุฑุนโุชุฑู ู ฺฉูุฏุชุฑู
3. **ุนุฏู ุงุณุชูุงุฏู ุงุฒ Context** - RAG ุจู ุฏุฑุณุช ฺฉุงุฑ ููโฺฉูุฏ
4. **ฺฉ outlier ุดุฏุฏ** - ุณูุงู #2 ุจุง 89 ุซุงูู!

### ๐ฏ ุงูููุช ุงูุฏุงูุงุช

**ููุฑ (ุงู ููุชู):**
1. ุชุณุช ุจุง OpenAI ุจู ุนููุงู primary
2. ุจุฑุฑุณ ู ุฑูุน ูุดฺฉู context usage
3. ูพุงุฏูโุณุงุฒ caching ุจุฑุง ุณูุงูุงุช ูุดุงุจู

**ูุงูโูุฏุช (ุงู ูุงู):**
4. ุจูููโุณุงุฒ prompt ุจุฑุง ุงุณุชูุงุฏู ุจูุชุฑ ุงุฒ ููุงุจุน
5. ูพุงุฏูโุณุงุฒ streaming response
6. ุงูุฒูุฏู monitoring ู alerting ุจุฑุง outliers

**ุจููุฏูุฏุช (ุณู ูุงู ุขูุฏู):**
7. ุจุฑุฑุณ ุงุณุชูุงุฏู ุงุฒ local LLM ุจุฑุง pre-filtering
8. ูพุงุฏูโุณุงุฒ adaptive timeout
9. ุชูุณุนู ุณุณุชู caching ููุดููุฏ

---

**ุชููโฺฉููุฏู:** Cascade AI  
**ุชุงุฑุฎ:** 16 ููุฑู 2026  
**ูุณุฎู:** 1.0

# ุญุงูุธู ูพุฑูฺู RAG Core

ุงู ูุงู ุดุงูู ุชุงุฑุฎฺู ุชุตููุงุชุ ุงูุฏุงูุงุช ู ูุชโูุง ุชูุณุนูโุฏููุฏู ุงุณุช. ููฺฏุงู ฺฉุงุฑ ุจุง ุงู ูพุฑูฺูุ ุงู ูุงู ุฑุง ุจุฎูุงูุฏ.

---

## ๐ฏ ูุฏู ฺฉู ูพุฑูฺู

ฺฉ ุณุณุชู RAG (Retrieval-Augmented Generation) ุจุฑุง ูพุงุณุฎ ุจู ุณูุงูุงุช ุญูููุ ูุงูุงุช ู ฺฉุณุจโูฺฉุงุฑ ุฏุฑ ุฒุจุงู ูุงุฑุณ.

---

## ๐ ุณุงุฎุชุงุฑ ฺฉูุฏ ูุงูโูุง

| ูุงู | ุชูุถุญ |
|------|-------|
| `/srv/app/rag/pipeline.py` | ุฎุท ูููู ุงุตู RAG |
| `/srv/app/config/prompts.py` | ุชูุงู prompt ูุง ุณุณุชู (ูุชูุฑฺฉุฒ) |
| `/srv/app/api/v1/endpoints/query.py` | endpoint ุงุตู ูพุฑุณุด |
| `/srv/app/api/v1/endpoints/query_utils.py` | ุชูุงุจุน ฺฉูฺฉ query |
| `/srv/app/llm/classifier.py` | ุฏุณุชูโุจูุฏ ุณูุงูุงุช ฺฉุงุฑุจุฑ |
| `/srv/app/services/file_analysis_service.py` | ุชุญูู ูุงูโูุง ุขูพููุฏ ุดุฏู |

---

## ๐ท๏ธ ุฏุณุชูโุจูุฏ ุณูุงูุงุช (Classification)

ุณุณุชู ุณูุงูุงุช ุฑุง ุจู 5 ุฏุณุชู ุชูุณู ูโฺฉูุฏ:

1. **invalid_no_file** - ูุชู ุจโูุนู ุจุฏูู ูุงู
2. **invalid_with_file** - ูุชู ุจโูุนู ุจุง ูุงู
3. **general** - ุณูุงูุงุช ุนูููุ ุบุฑุชุฎุตุต
4. **business_no_file** - ุณูุงูุงุช ุญููู/ูุงู ุจุฏูู ูุงู
5. **business_with_file** - ุณูุงูุงุช ุญููู/ูุงู ุจุง ูุงู

### ููุงูู ููู ุฏุณุชูโุจูุฏ:
- ุณูุงู "ุงู ูุงู ฺู" โ ููุดู **general**
- ุฌุฒูู/ฺฉุชุงุจ/ุชุณุช โ **general** (ูู business)
- ููุท ูุฑุงุฑุฏุงุฏ/ุตูุฑุชุญุณุงุจ/ุจููโูุงูู โ **business_with_file**

---

## ๐ง ุงุตูุงุญุงุช ุงูุฌุงู ุดุฏู

### 1. ูุชูุฑฺฉุฒุณุงุฒ Prompt ูุง (ุฏุณุงูุจุฑ 2025)
- ุชูุงู prompt ูุง ุงุฒ ูุงูโูุง ูุฎุชูู ุจู `prompts.py` ููุชูู ุดุฏูุฏ
- ฺฉูุงุณโูุง ุฌุฏุฏ: `FileAnalysisPrompts`, `MemoryPrompts`, `QueryEnhancementPrompts`

### 2. ุฐุฎุฑู ูุญุชูุง ูุงู ุฏุฑ ุชุงุฑุฎฺู ูฺฉุงููู
- **ูุดฺฉู:** ูุฏู ุฏุฑ ูพุงูโูุง ุจุนุฏ ุจู ูุญุชูุง ูุงู ุฏุณุชุฑุณ ูุฏุงุดุช
- **ุฑุงู ุญู:** ุชุงุจุน `build_user_message_content()` ุฏุฑ `query_utils.py`
- ุญุฏุงฺฉุซุฑ 4000 ฺฉุงุฑุงฺฉุชุฑ ุงุฒ ูุญุชูุง ูุงู ุฏุฑ ูพุงู ฺฉุงุฑุจุฑ ุฐุฎุฑู ูโุดูุฏ

### 3. Refactor ฺฉุฑุฏู Classification Prompt
- **ูุดฺฉู:** prompt ุฎู ุทููุงู ู ุชฺฉุฑุงุฑ ุจูุฏ
- **ุฑุงู ุญู:** ฺฉุงูุด ุงุฒ ~3500 ฺฉุงุฑุงฺฉุชุฑ ุจู ~1434 ฺฉุงุฑุงฺฉุชุฑ
- ุญูุธ ููุงูู ฺฉูุฏุ ุญุฐู ุชฺฉุฑุงุฑูุง

### 4. Refactor ฺฉุฑุฏู pipeline.py
- ุญุฐู import ูุง ุชฺฉุฑุงุฑ ุฏุงุฎู
- ุงูุชูุงู prompt enhancement ุจู `prompts.py`
- ุณุงุฏูโุณุงุฒ ูุชุฏูุง ุทููุงู
- ฺฉุงูุด ~100 ุฎุท ฺฉุฏ

---

## โ๏ธ ูฺฉุงุช ููู ุจุฑุง ุชูุณุนู ุขูุฏู

### ููฺฏุงู ุชุบุฑ prompt ูุง:
1. ููู prompt ูุง ุฏุฑ `/srv/app/config/prompts.py` ูุณุชูุฏ
2. ูุฑฺฏุฒ prompt ุฑุง ูุณุชูู ุฏุฑ ฺฉุฏ ูููุณุฏ
3. ูุญุฏูุฏุช 3000 ฺฉุงุฑุงฺฉุชุฑ ุจุฑุง ุชุญูู ูุงู ุฑุนุงุช ุดูุฏ

### ููฺฏุงู ฺฉุงุฑ ุจุง ูุงูโูุง:
1. ูุญุชูุง ูุงู ุจุงุฏ ุฏุฑ ุชุงุฑุฎฺู ุฐุฎุฑู ุดูุฏ (ุจุฑุง follow-up)
2. ุชุตุงูุฑ ุจู ุตูุฑุช `input_image` ุจุง URL ุจู LLM ุงุฑุณุงู ูโุดููุฏ
3. ุญุฏุงฺฉุซุฑ 4000 ฺฉุงุฑุงฺฉุชุฑ ุงุฒ ูุญุชูุง ุฏุฑ ุชุงุฑุฎฺู ุฐุฎุฑู ูโุดูุฏ

### ููฺฏุงู ฺฉุงุฑ ุจุง RAG:
1. `RAGPipeline` ุฏุฑ `pipeline.py` ุงุณุช
2. ุงุฒ `RAGQuery` ุจุฑุง ุณุงุฎุช query ุงุณุชูุงุฏู ฺฉูุฏ
3. `temporal_context` ุจุฑุง ููุชุฑ ููุงูู ุจุฑ ุงุณุงุณ ุชุงุฑุฎ

---

## ๐ TODO ูุง ุจุงูโูุงูุฏู

- [ ] ุจูุจูุฏ ุฏูุช classifier ุจุฑุง ููุงุฑุฏ edge case
- [ ] ุงุถุงูู ฺฉุฑุฏู ุชุณุชโูุง ูุงุญุฏ
- [ ] ุจูููโุณุงุฒ ุนููฺฉุฑุฏ reranker

---

## ๐ ุงุฏุฏุงุดุชโูุง ุฌูุณุงุช

### ุฌูุณู ุขุฎุฑ (ุฏุณุงูุจุฑ 2025)
- Refactor ฺฉุงูู `pipeline.py`
- Refactor ฺฉุฑุฏู Classification Prompt
- ุงุตูุงุญ ุฐุฎุฑู ูุญุชูุง ูุงู ุฏุฑ ุชุงุฑุฎฺู ูฺฉุงููู
- ุงูุชูุงู ุชูุงู prompt ูุง ุจู `prompts.py`

---
---

## ๐ ุงุชุตุงู ุณุณุชูโูุง ุฎุงุฑุฌ ุจู RAG Core โ ุชุฌุฑุจุงุช ู ูฺฉุงุช ููู

> ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู: 2026-02-13

### ูุงููู ุทูุง
- **ุณุณุชู ูุฑฺฉุฒ (RAG Core) ูุฑุฌุน ุงุตู ุชูุธูุงุช ุงุณุช**
- ุณุณุชูโูุง ุฏฺฏุฑ (Users Systemุ Ingest System) ุจุงุฏ ุฎูุฏุดุงู ุฑุง ุจุง ุณุณุชู ูุฑฺฉุฒ ููุงููฺฏ ฺฉููุฏ
- ูุฑฺฏุฒ JWT_SECRET_KEY ุณุณุชู ูุฑฺฉุฒ ุฑุง ุจุฑุง ููุงููฺฏ ุจุง ุณุณุชูโูุง ุฏฺฏุฑ ุชุบุฑ ูุฏูุฏ

### ูุนูุงุฑ ุดุจฺฉู
| ุณุฑูุฑ | IP | ููุด |
|------|-----|------|
| RAG Core (ูุฑฺฉุฒ) | `10.10.10.20:7001` | ุณุณุชู ููุด ูุตููุน ู RAG |
| Users System (ุจฺฉูุฏ/ูุฑุงูุช) | `10.10.10.30` | ุจฺฉูุฏ Django + ูุฑุงูุช Next.js |
| MinIO/S3 | `10.10.10.50:9000` | ุฐุฎุฑูโุณุงุฒ ูุงู |

### JWT_SECRET_KEY โ ููุงููฺฏ ุจู ุณุณุชูโูุง
- ฺฉูุฏ JWT ุฏุฑ `/srv/.env` ุฎุท `JWT_SECRET_KEY` ุชุนุฑู ุดุฏู
- Users System ุงุฒ `djangorestframework-simplejwt` ุงุณุชูุงุฏู ูโฺฉูุฏ ู ุจุงุฏ ููู ฺฉูุฏ ุฑุง ุฏุงุดุชู ุจุงุดุฏ
- RAG Core ุงุฒ `python-jose` ุจุฑุง verify ุงุณุชูุงุฏู ูโฺฉูุฏ
- ุชูุธูุงุช simplejwt ุฏุฑ Users System ุจุงุฏ ุดุงูู ุจุงุดุฏ:
  - `USER_ID_CLAIM = 'sub'`
  - `TOKEN_TYPE_CLAIM = 'type'`
  - `ALGORITHM = 'HS256'`

### TrustedHostMiddleware โ ููู!
- ูุงู: `/srv/app/main.py`
- ุฏุฑ ุญุงูุช productionุ ููุท IP ูุง ูุฌุงุฒ ูโุชูุงููุฏ ุฏุฑุฎูุงุณุช ุจูุฑุณุชูุฏ
- IP ูุง ุฏุงุฎู ุดุจฺฉู (`10.10.10.20`, `10.10.10.30`, `10.10.10.40`, `10.10.10.50`) ุงุถุงูู ุดุฏูโุงูุฏ
- ุงฺฏุฑ ุณุฑูุฑ ุฌุฏุฏ ุงุถุงูู ุดุฏุ IP ุขู ุจุงุฏ ุจู `allowed_hosts` ุฏุฑ `main.py` ุงุถุงูู ุดูุฏ

### ูุดฺฉูุงุช ุฑุงุฌ ู ุฑุงูโุญูโูุง

#### 1. ุฎุทุง 401 "Invalid authentication token"
- **ุนูุช**: JWT_SECRET_KEY ุณุณุชู ุฎุงุฑุฌ ุจุง RAG Core ฺฉุณุงู ูุณุช
- **ุฑูุน**: ฺฉูุฏ JWT ุณุณุชู ุฎุงุฑุฌ ุฑุง ุจุง ฺฉูุฏ RAG Core ููุงููฺฏ ฺฉูุฏ (ูู ุจุฑุนฺฉุณ!)

#### 2. ุฎุทุง 400 "Invalid host header"
- **ุนูุช**: IP ุณุฑูุฑ ุฏุฑุฎูุงุณุชโุฏููุฏู ุฏุฑ `TrustedHostMiddleware` ูุณุช
- **ุฑูุน**: IP ุฑุง ุจู `allowed_hosts` ุฏุฑ `/srv/app/main.py` ุงุถุงูู ฺฉูุฏ

#### 3. ุฎุทุง 307 Redirect
- **ุนูุช**: FastAPI trailing slash โ ุฏุฑุฎูุงุณุช ุจู `/api/v1/query` ุจู `/api/v1/query/` redirect ูโุดูุฏ
- **ุฑูุน**: ุณุณุชู ุฎุงุฑุฌ ุจุงุฏ `follow_redirects=True` ุฏุฑ httpx client ุฏุงุดุชู ุจุงุดุฏ

#### 4. ุฎุทุง AttributeError: llm_fallback_api_key
- **ุนูุช**: ุจุนุฏ ุงุฒ refactor LLM1/LLM2ุ property ูุง backward compatibility ูุฑุงููุด ุดุฏู ุจูุฏ
- **ุฑูุน**: property ูุง `llm_fallback_*` ุฏุฑ `/srv/app/config/settings.py` ุงุถุงูู ุดุฏ
- **ุฏุฑุณ**: ููฺฏุงู refactorุ ููุดู backward compatibility property ูุง ุฑุง ุญูุธ ฺฉูุฏ

### ุชูุธูุงุช Production
- `ENVIRONMENT="production"`, `DEBUG=false`, `RELOAD=false`
- ุจุนุฏ ุงุฒ RELOAD=falseุ ุชุบุฑุงุช ฺฉุฏ ุฎูุฏฺฉุงุฑ ุงุนูุงู ููโุดููุฏ
- ุจุฑุง ุงุนูุงู ุชุบุฑุงุช:
  ```bash
  docker stop core-api && docker rm core-api
  cd /srv/deployment/docker && docker compose up -d --no-build core-api



*ุงู ูุงู ุฑุง ูุจู ุงุฒ ุดุฑูุน ูุฑ ฺฉุงุฑ ุจุฎูุงูุฏ.*
